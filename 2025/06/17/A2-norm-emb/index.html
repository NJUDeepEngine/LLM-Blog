<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/LLM-Blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/LLM-Blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/LLM-Blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/LLM-Blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/LLM-Blog/css/main.css">


<link rel="stylesheet" href="/LLM-Blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"njudeepengine.github.io","root":"/LLM-Blog/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬å°†å®ç° Transfomer ä¸­çš„ä¸¤ä¸ªå…³é”®æ¨¡å—ï¼šå‡æ–¹æ ¹å±‚å½’ä¸€åŒ–ï¼ˆRMSNormï¼‰å’Œè¯åµŒå…¥ï¼ˆEmbeddingï¼‰å±‚ã€‚RMSNorm æ˜¯ä¸€ç§é«˜æ•ˆçš„å½’ä¸€åŒ–æ–¹æ³•ï¼Œé€šè¿‡ä»…åˆ©ç”¨è¾“å…¥çš„å‡æ–¹æ ¹å€¼è¿›è¡Œå½’ä¸€åŒ–ï¼Œåœ¨ä¿æŒæ¨¡å‹æ€§èƒ½çš„å‰æä¸‹ï¼Œæå‡äº†è®¡ç®—æ•ˆç‡ä¸è®­ç»ƒç¨³å®šæ€§ã€‚Embedding å±‚åˆ™å¹¿æ³›åº”ç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç¦»æ•£çš„ç¬¦å·ï¼ˆå¦‚å•è¯æˆ–å­è¯ï¼‰æ˜ å°„ä¸ºç¨ å¯†çš„å‘é‡è¡¨ç¤ºï¼Œä»è€Œä¸ºæ¨¡å‹æä¾›å¯å­¦ä¹ çš„è¯­ä¹‰">
<meta property="og:type" content="article">
<meta property="og:title" content="A2 RMSNorm and Embedding">
<meta property="og:url" content="https://njudeepengine.github.io/2025/06/17/A2-norm-emb/index.html">
<meta property="og:site_name" content="LLM-Assignment-Doc">
<meta property="og:description" content="åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬å°†å®ç° Transfomer ä¸­çš„ä¸¤ä¸ªå…³é”®æ¨¡å—ï¼šå‡æ–¹æ ¹å±‚å½’ä¸€åŒ–ï¼ˆRMSNormï¼‰å’Œè¯åµŒå…¥ï¼ˆEmbeddingï¼‰å±‚ã€‚RMSNorm æ˜¯ä¸€ç§é«˜æ•ˆçš„å½’ä¸€åŒ–æ–¹æ³•ï¼Œé€šè¿‡ä»…åˆ©ç”¨è¾“å…¥çš„å‡æ–¹æ ¹å€¼è¿›è¡Œå½’ä¸€åŒ–ï¼Œåœ¨ä¿æŒæ¨¡å‹æ€§èƒ½çš„å‰æä¸‹ï¼Œæå‡äº†è®¡ç®—æ•ˆç‡ä¸è®­ç»ƒç¨³å®šæ€§ã€‚Embedding å±‚åˆ™å¹¿æ³›åº”ç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç¦»æ•£çš„ç¬¦å·ï¼ˆå¦‚å•è¯æˆ–å­è¯ï¼‰æ˜ å°„ä¸ºç¨ å¯†çš„å‘é‡è¡¨ç¤ºï¼Œä»è€Œä¸ºæ¨¡å‹æä¾›å¯å­¦ä¹ çš„è¯­ä¹‰">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-06-17T06:17:05.000Z">
<meta property="article:modified_time" content="2025-08-26T09:12:32.239Z">
<meta property="article:author" content="DeepEngine">
<meta property="article:tag" content="RMSNorm">
<meta property="article:tag" content="Vocab Embedding">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://njudeepengine.github.io/2025/06/17/A2-norm-emb/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>A2 RMSNorm and Embedding | LLM-Assignment-Doc</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/LLM-Blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">LLM-Assignment-Doc</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/LLM-Blog/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/LLM-Blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/LLM-Blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://njudeepengine.github.io/2025/06/17/A2-norm-emb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/LLM-Blog/images/avatar.gif">
      <meta itemprop="name" content="DeepEngine">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LLM-Assignment-Doc">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          A2 RMSNorm and Embedding
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-06-17 14:17:05" itemprop="dateCreated datePublished" datetime="2025-06-17T14:17:05+08:00">2025-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-26 17:12:32" itemprop="dateModified" datetime="2025-08-26T17:12:32+08:00">2025-08-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/LLM-Blog/categories/Assignment/" itemprop="url" rel="index"><span itemprop="name">Assignment</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬å°†å®ç° <em>Transfomer</em> ä¸­çš„ä¸¤ä¸ªå…³é”®æ¨¡å—ï¼šå‡æ–¹æ ¹å±‚å½’ä¸€åŒ–ï¼ˆ<strong>RMSNorm</strong>ï¼‰å’Œè¯åµŒå…¥ï¼ˆ<strong>Embedding</strong>ï¼‰å±‚ã€‚<strong>RMSNorm</strong> æ˜¯ä¸€ç§é«˜æ•ˆçš„å½’ä¸€åŒ–æ–¹æ³•ï¼Œé€šè¿‡ä»…åˆ©ç”¨è¾“å…¥çš„å‡æ–¹æ ¹å€¼è¿›è¡Œå½’ä¸€åŒ–ï¼Œåœ¨ä¿æŒæ¨¡å‹æ€§èƒ½çš„å‰æä¸‹ï¼Œæå‡äº†è®¡ç®—æ•ˆç‡ä¸è®­ç»ƒç¨³å®šæ€§ã€‚<strong>Embedding</strong> å±‚åˆ™å¹¿æ³›åº”ç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å°†ç¦»æ•£çš„ç¬¦å·ï¼ˆå¦‚å•è¯æˆ–å­è¯ï¼‰æ˜ å°„ä¸ºç¨ å¯†çš„å‘é‡è¡¨ç¤ºï¼Œä»è€Œä¸ºæ¨¡å‹æä¾›å¯å­¦ä¹ çš„è¯­ä¹‰åŸºç¡€ã€‚</p>
<h1 id="Task-1-å‡æ–¹æ ¹å±‚å½’ä¸€åŒ–-RMS-Norm"><a href="#Task-1-å‡æ–¹æ ¹å±‚å½’ä¸€åŒ–-RMS-Norm" class="headerlink" title="Task 1: å‡æ–¹æ ¹å±‚å½’ä¸€åŒ– (RMS Norm)"></a>Task 1: å‡æ–¹æ ¹å±‚å½’ä¸€åŒ– (RMS Norm)</h1><p>å‡æ–¹æ ¹å±‚å½’ä¸€åŒ–ï¼ˆRMS Normï¼‰æ˜¯æ·±åº¦å­¦ä¹ ä¸­åº”ç”¨æœ€å¹¿æ³›çš„å½’ä¸€åŒ–æ¨¡å—ï¼Œå°¤å…¶åœ¨è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰å’Œå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰é¢†åŸŸã€‚è¯¥æ¨¡å—ä»¥å½¢çŠ¶ä¸º <code>[batch_size, seqlen, hidden_size]</code> çš„å¼ é‡ä¸ºè¾“å…¥ï¼ˆè®°ä¸º <code>X</code>ï¼Œå½¢çŠ¶ä¸º <code>[b, s, h]</code>ï¼‰ï¼Œå¹¶æ²¿ç€éšè—å±‚ <code>h</code> ç»´åº¦ï¼Œæ‰§è¡Œå¸¦å¯å­¦ä¹ ç¼©æ”¾å˜æ¢çš„å‡æ–¹æ ¹å½’ä¸€åŒ–æ“ä½œï¼Œå¾—åˆ°è¾“å‡º <code>Y</code>ï¼Œå½¢çŠ¶ä¸º <code>[b, s, h]</code>ã€‚å…·ä½“å…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<script type="math/tex; mode=display">
Y=\frac{X}{RMS[X]} \odot \gamma \tag{1}</script><script type="math/tex; mode=display">
RMS[X]=\sqrt{\frac{1}{h} \sum_{i=1}^{h}x_i^2 + \epsilon} \tag{2}</script><p>å…¶ä¸­ï¼Œ$RMS[X]$ è¡¨ç¤º <code>X</code> çš„å‡æ–¹æ ¹ï¼Œå¯¹äº <code>i in batch_size</code> ä¸” <code>j in seqlen</code>ï¼Œå¯¹æ¯ä¸€ä¸ª <code>X[i][j]</code>ï¼ˆå½¢çŠ¶ä¸º <code>[hidden_size, ]</code>ï¼‰ï¼Œç‹¬ç«‹åœ°è®¡ç®— <em>RMS</em>ï¼›$\epsilon$ æ˜¯ä¸€ä¸ªæå°çš„å¸¸æ•°ï¼Œç”¨äºé¿å…é™¤æ•°ä¸º0ï¼Œè®°ä½œ <code>eps</code>ï¼›$\gamma$ æ˜¯æ²¿ <code>h</code> ç»´åº¦çš„å¯å­¦ä¹ å‚æ•°çŸ©é˜µï¼Œç›´æ¥ä¸æ‰€æœ‰ <code>batch_size</code> å’Œ <code>seqlen</code> çš„éšè—å±‚åš <em>Hadamard</em> ä¹˜ç§¯ï¼Œè‹¥ <code>X</code> çš„å½¢çŠ¶ä¸º <code>[b, s, h]</code>ï¼Œåˆ™ $\gamma$ åº”è¯¥æ˜¯ä¸€ä¸ªå½¢çŠ¶ä¸º <code>[1, 1, h]</code> çš„å‚æ•°çŸ©é˜µã€‚</p>
<p>ä¸ºäº†å°†ä¸Šè¿°å‡æ–¹æ ¹å±‚å½’ä¸€åŒ–æ³›åŒ–ï¼Œåœ¨ <strong>Task1</strong> ä¸­æˆ‘ä»¬å°†å®ç°ä¸Šè¿°æ¨¡å—çš„ä¸€ä¸ªå˜ä½“ï¼Œç§°ä¸ºåˆ†ç»„å‡æ–¹æ ¹å±‚å½’ä¸€åŒ–ï¼ˆ<strong>Group RMSNorm</strong>ï¼‰ã€‚ç»™å®šåˆ†ç»„å¤§å° <code>group size</code>ï¼Œç®€è®°ä¸º <code>gz</code>ï¼Œå°† <code>X</code>  å’Œ $\gamma$ çš„éšè—å±‚ç»´åº¦ <code>h</code> å‡åŒ€åˆ’åˆ†ä¸º <code>Xg</code> ç»„ï¼Œå¹¶å¯¹ç¬¬ <code>i</code> ç»„åˆ†åˆ«åº”ç”¨ $(1) (2)$ å¼ä¸­çš„ <em>RMS Norm</em> æ“ä½œï¼Œå…·ä½“å…¬å¼å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
Y_{g_i}=\frac{X_{g_i}}{RMS[X_{g_i}]} \odot \gamma_{g_i} \tag{3}</script><script type="math/tex; mode=display">
RMS[X_{g_i}]=\sqrt{\frac{1}{gz} \sum_{j=1}^{gz}x_{g_i, j}^2 + \epsilon} \tag{4}</script><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥ä¸ºè¯¥ <em>Group RMS Norm</em> æ¨¡å—å®ç°ä¸€ä¸ªåä¸º <code>reset_parameters</code> çš„å‚æ•°åˆå§‹åŒ–æ–¹æ³•ï¼Œç”¨äºä¸ºå¯å­¦ä¹ çš„å‚æ•°çŸ©é˜µ $\gamma$ è®¾ç½®åˆå§‹å€¼ã€‚æˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ªéšæœºæ•°ç§å­ï¼ˆè®°ä¸º <code>init_seed</code>ï¼Œå¦‚42ï¼‰å’Œä¸€ä¸ªåˆå§‹å€¼èŒƒå›´å…ƒç¥–ï¼ˆè®°ä¸º <code>init_range</code>ï¼Œå¦‚ <code>(-1, 1)</code>ï¼‰ï¼Œè¯·ä½¿ç”¨å‡åŒ€åˆ†å¸ƒï¼ˆ<strong>uniform distribution</strong>ï¼‰å’Œ <em>pytorch</em> è‡ªå¸¦çš„åˆå§‹åŒ–æ–¹æ³•ä¸º <em>Parameter</em> åˆå§‹åŒ–ã€‚ </p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>å®Œæˆ <code>src/modeling/norm.py</code> ä¸­çš„ <code>GroupRMSNorm</code> æ¨¡å—ï¼Œå®ç°ä¸Šè¿°å‚æ•°åˆå§‹åŒ–å’Œåˆ†ç»„å‡æ–¹æ ¹å½’ä¸€åŒ–ã€‚é¦–å…ˆï¼Œä½ éœ€è¦æ ¹æ® <code>init_range</code> å’Œ <code>init_seed</code> ï¼Œä½¿ç”¨ <strong>uniform distribution</strong> ä¸º $\gamma$ åˆå§‹åŒ–ï¼Œç„¶åå°† <code>X</code> å’Œ <code>gz</code> ä½œä¸ºè¾“å…¥ï¼Œå®ç°<strong>Group RMSNorm</strong>ï¼Œå¹¶è¿”å›è¾“å‡º <code>Y</code>ï¼Œå½¢çŠ¶ä¸º <code>[batch_size, seqlen, hidden_size]</code>ã€‚</p>
<div class="note warning">
            <ol><li>å‚æ•°ä¸­çš„ <code>dtype</code> å’Œ <code>device</code> ä»…é’ˆå¯¹å¯å­¦ä¹ å‚æ•°çŸ©é˜µ $\gamma$ ï¼Œ$\gamma$ çš„ <code>dtype</code> å’Œ <code>device</code> å¯èƒ½ä¸ <code>X</code> çš„ä¸åŒï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‚æ•°å’Œ <code>torch.nn.Parameter</code> å®Œæˆå¯¹ $\gamma$ çš„ç”³è¯·ä¸åˆå§‹åŒ–ã€‚</li><li>è¾“å‡º <code>Y</code> çš„å±æ€§ï¼ˆåŒ…æ‹¬ <code>dtype</code> å’Œ <code>device</code>ï¼‰å¿…é¡»ä¸è¾“å…¥ <code>X</code> ä¿æŒä¸€è‡´ã€‚</li><li>ç”±äºå‡æ–¹æ ¹å½’ä¸€åŒ–ï¼ˆ<em>RMS Norm</em>ï¼‰æ¶‰åŠé™¤æ³•è®¡ç®—ï¼Œå»ºè®®ä½¿ç”¨ <code>float32</code> ç­‰é«˜ç²¾åº¦æ•°æ®ç±»å‹ä»¥ä¿æŒæ•°å€¼ç¨³å®šã€‚</li><li>åœ¨æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œ<code>h</code> å‡èƒ½è¢« <code>gz</code> æ•´é™¤ï¼Œä½†ä»ç„¶å»ºè®®åœ¨ <code>__init__</code> æ–¹æ³•ä¸­ä½¿ç”¨ <code>assert</code> è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶é™„ä¸Šé”™è¯¯æç¤ºï¼Œè¿™æ˜¯ç¼–ç¨‹çš„è‰¯å¥½ä¹ æƒ¯ã€‚</li><li>åˆå§‹åŒ–å‚æ•°æ—¶ï¼Œ<code>reset_parameters</code> æ–¹æ³•åº”åœ¨ <code>__init__</code> æ–¹æ³•ä¸­è°ƒç”¨ä¸€æ¬¡ã€‚</li></ol>
          </div>
<div class="note info">
            <p>è¯·è‡ªè¡ŒæŸ¥é˜… <code>pytorch</code> ä¸­ä¹˜æ³•çš„å¹¿æ’­æœºåˆ¶ï¼Œå¯¹ <strong>Task1</strong> çš„å®ç°æœ‰å¾ˆå¤§å¸®åŠ©ã€‚</p>
          </div>
<h1 id="Task-2-åµŒå…¥è¯è¡¨-Vocab-Embedding"><a href="#Task-2-åµŒå…¥è¯è¡¨-Vocab-Embedding" class="headerlink" title="Task 2: åµŒå…¥è¯è¡¨ (Vocab Embedding)"></a>Task 2: åµŒå…¥è¯è¡¨ (Vocab Embedding)</h1><p>åœ¨ <strong>Task2</strong> ä¸­ï¼Œæˆ‘ä»¬å°†è¦å®ç°ä¸€ä¸ªåµŒå…¥è¯è¡¨ï¼Œä»¥è·å–ä¹‹å‰ä»»åŠ¡ä¸­çš„è¾“å…¥ <code>X</code>ã€‚å‡è®¾è¯è¡¨çš„å¤§å°ä¸º <code>vocab_size</code>ï¼Œç®€è®°ä¸º <code>v</code>ï¼ŒåµŒå…¥è¯è¡¨æ¨¡å—ä»¥å½¢çŠ¶ä¸º <code>[batch_size, seqlen]</code> çš„å¼ é‡ <code>I</code> ä½œä¸ºè¾“å…¥ï¼Œå¼ é‡ <code>I</code> ä¸­å­˜å‚¨äº†æ¯ä¸ª token çš„ IDï¼ŒID çš„èŒƒå›´æ˜¯ <code>[0, v-1]</code>ã€‚é€šè¿‡æŸ¥è¯¢å¯å­¦ä¹ çš„åµŒå…¥è¡¨ï¼ˆè®°ä¸º <code>T</code>ï¼Œå½¢çŠ¶ä¸º <code>[v, e]</code>ï¼‰ï¼Œä¸ºå¼ é‡ <code>I</code> ä¸­çš„æ¯ä¸ª ID åˆ†é…å¯¹åº”çš„åµŒå…¥å‘é‡ï¼Œå¹¶è¿”å›å½¢çŠ¶ä¸º <code>[batch_size, seqlen, emb_size]</code> çš„åµŒå…¥å¼ é‡ <code>E</code>ï¼Œç®€è®°ä¸º <code>[b, s, e]</code>ã€‚</p>
<p>ä¸ <strong>Task1</strong> ç±»ä¼¼ï¼Œä½ è¿˜åº”è¯¥ä¸º <code>VocabEmbedding</code> æ¨¡å—ç±»å®ç° <code>reset_parameters</code> æ–¹æ³•ï¼Œç”¨äºåµŒå…¥è¡¨ <code>T</code> çš„åˆå§‹åŒ–ã€‚é€‰ç”¨æ­£æ€åˆ†å¸ƒï¼ˆ<strong>normal distribution</strong>ï¼‰ï¼Œç»™å®šå¹³å‡å€¼ï¼ˆè¡¨ç¤ºä¸º <code>init_mean</code>ï¼Œå¦‚ <code>0.</code>ï¼‰ï¼Œæ ‡å‡†å·®ï¼ˆè¡¨ç¤ºä¸º <code>init_std</code>ï¼Œå¦‚ <code>1.</code>ï¼‰ï¼Œä»¥åŠéšæœºæ•°ç§å­ï¼ˆè¡¨ç¤ºä¸º <code>init_seed</code>ï¼Œå¦‚ <code>42</code>ï¼‰ï¼Œå¯¹åµŒå…¥è¡¨ <code>T</code> åˆå§‹åŒ–ï¼Œ<code>reset_parameters</code> æ–¹æ³•åŒæ ·éœ€è¦åœ¨ <code>__init__</code> ä¸­æ˜¾ç¤ºè°ƒç”¨ã€‚</p>
<h2 id="TODO-1"><a href="#TODO-1" class="headerlink" title="TODO"></a>TODO</h2><p>å®Œæˆ <code>src/modeling/vocab_emb.py</code> ä¸­çš„ <code>VocabEmbedding</code> æ¨¡å—ï¼Œå®ç°ä¸Šè¿°åµŒå…¥è¯è¡¨ã€‚é¦–å…ˆï¼Œä½ éœ€è¦æ ¹æ® <code>init_mean</code>, <code>init_std</code> å’Œ <code>init_seed</code>ï¼Œä½¿ç”¨ <strong>normal distribution</strong> å¯¹åµŒå…¥è¡¨ <code>T</code> åˆå§‹åŒ–ï¼Œç„¶åå°† <code>I</code> ä½œä¸ºè¾“å…¥ï¼Œå®ç°è¯è¡¨åµŒå…¥ï¼Œå¹¶è¿”å›åµŒå…¥å¼ é‡ <code>E</code>ã€‚</p>
<div class="note warning">
            <ol><li>è¾“å…¥ <code>I</code> å­˜å‚¨æ¯ä¸ª token çš„ IDï¼Œå…¶ <code>dtype</code> ä¸º <code>torch.long</code>ã€‚</li><li>ä½ çš„å®ç°ä¸åº”è¯¥æ›´æ”¹ <code>I</code>ï¼ŒåŒ…æ‹¬ <code>I</code> çš„æ•°å€¼ä¸å±æ€§ï¼ˆåŒ…æ‹¬ <code>I</code> çš„ <code>shape</code>ï¼Œ <code>dtype</code> å’Œ <code>device</code> ç­‰ï¼‰ï¼Œå› ä¸º <code>I</code> å¯èƒ½è¿˜æœ‰å…¶ä»–ç”¨é€”ã€‚</li><li>å‚æ•°ä¸­çš„ <code>dtype</code> å’Œ <code>device</code> ä»…é’ˆå¯¹å¯å­¦ä¹ åµŒå…¥è¡¨ <code>T</code> ï¼Œ<code>T</code> çš„ <code>dtype</code> å’Œ <code>device</code> å¯èƒ½ä¸ <code>I</code> çš„ä¸åŒï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‚æ•°å’Œ <code>torch.nn.Parameter</code> å®Œæˆå¯¹ <code>T</code> çš„ç”³è¯·ä¸åˆå§‹åŒ–ã€‚</li><li>è¿”å›çš„åµŒå…¥å¼ é‡ <code>E</code> çš„ <code>device</code> åº”ä¸ <code>I</code> ç›¸åŒï¼Œ<code>dtype</code> ä¸ <code>T</code> ç›¸åŒã€‚</li></ol>
          </div>
<h1 id="Task-3-åˆ†å¸ƒå¼å¹¶è¡ŒåµŒå…¥è¯è¡¨-Parallel-Vocab-Embedding"><a href="#Task-3-åˆ†å¸ƒå¼å¹¶è¡ŒåµŒå…¥è¯è¡¨-Parallel-Vocab-Embedding" class="headerlink" title="Task 3: åˆ†å¸ƒå¼å¹¶è¡ŒåµŒå…¥è¯è¡¨ (Parallel Vocab Embedding)"></a>Task 3: åˆ†å¸ƒå¼å¹¶è¡ŒåµŒå…¥è¯è¡¨ (Parallel Vocab Embedding)</h1><p>åœ¨ <strong>Task3</strong> ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨ <strong>Task2</strong> å®ç°çš„åµŒå…¥è¯è¡¨çš„åŸºç¡€ä¸Šï¼Œå®ç°åˆ†å¸ƒå¼çš„åµŒå…¥è¯è¡¨ã€‚éšç€ <strong>LLM</strong> è§„æ¨¡è¿…é€Ÿæ‰©å¤§ï¼Œè¯è¡¨çš„å¤§å°å·²ç»å¢é•¿åˆ° <code>128K+</code>ï¼ŒåµŒå…¥è¯è¡¨å¾ˆéš¾åœ¨ä¸€å— <strong>GPU</strong>ä¸Šå­˜å‚¨å’Œè®¡ç®—ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªâ€œåˆ†å¸ƒå¼å¹¶è¡ŒåµŒå…¥è¯è¡¨â€æ¨¡å—è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å‡è®¾é€šä¿¡ç»„çš„å¤§å°ä¸º <code>world_size</code>ï¼Œç®€è®°ä¸º <code>w</code>ï¼Œåœ¨æœ¬å®éªŒä¸­ä½ å¯ä»¥ç®€å•çš„ç†è§£ä¸º <strong>GPU</strong> çš„æ•°é‡ï¼Œæ¯å— <strong>GPU</strong> éƒ½ä¼šæœ‰ä¸€ä¸ªåºå· <code>rank</code>ï¼ˆè®°ä¸º <code>r</code>ï¼Œä¸” $r \in[0,w-1]$ï¼‰ï¼Œæˆ‘ä»¬å°†å¤§å°ä¸º <code>v</code> çš„è¯è¡¨å‡åŒ€çš„åˆ†é…åˆ° <code>w</code> å¼  <strong>GPU</strong> ä¸­ï¼Œæ¯å¼ å¡è·å–å¤§å°ä¸º <code>v//w</code> çš„ä¸€ä¸ªåˆ†ç‰‡ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥å‡å°å•å¡ <strong>GPU</strong> ä¸­åµŒå…¥è¡¨çš„å­˜å‚¨å‹åŠ›ï¼Œè¿˜èƒ½å¹¶è¡Œæ‰§è¡Œè¯è¡¨åµŒå…¥ï¼Œä»¥åŠ é€Ÿè®¡ç®—ã€‚</p>
<div class="note info">
            <p>åœ¨çœŸå®çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œ<code>world_size</code> å’Œ <code>rank</code> éƒ½å¯ä»¥ç›´æ¥ä»ç¯å¢ƒå˜é‡å’Œé€šä¿¡ç»„ä¸­è·å–ï¼Œä½†é™äºèµ„æºæœ‰é™ï¼Œæˆ‘ä»¬çœå»é€šä¿¡ï¼Œä»…ä¿ç•™è®¡ç®—é€»è¾‘ï¼Œå¹¶ç›´æ¥åœ¨å‚æ•°ä¸­ç»™å‡º <code>world_size</code> å’Œ <code>rank</code>ï¼Œä»¥æ¨¡æ‹Ÿåˆ†å¸ƒå¼ç¯å¢ƒã€‚</p>
          </div>
<p>ç»™å®šè¯è¡¨å¤§å° <code>v</code>ï¼ŒåµŒå…¥ç»´åº¦ <code>e</code>ï¼Œ<strong>GPU</strong> åºå· <code>r</code>ï¼Œ<strong>GPU</strong> æ•°é‡ <code>w</code>ï¼Œå¹¶è¡Œè¯è¡¨åµŒå…¥æ¨¡å—çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¯¹äºåºå·ä¸º <code>r</code> çš„ <strong>GPU</strong>ï¼Œåˆ†å¾—å¤§å°ä¸º <code>n = v // m</code> çš„è¯è¡¨ï¼Œå…¶åªå…³æ³¨åŒºé—´ $[r \cdot n, (r+1)\cdot n-1]$ å†…çš„è¯å…ƒ IDï¼Œè¯¥åŒºé—´è®°ä¸º <code>R</code>ï¼›</li>
<li>ä»æ­£æ€åˆ†å¸ƒä¸­åˆå§‹åŒ–å±€éƒ¨åµŒå…¥è¡¨ <code>Tr</code>ï¼Œè¯·è‡ªè¡Œè®¡ç®— <code>Tr</code> çš„å½¢çŠ¶ï¼›</li>
<li>æ¥æ”¶è¾“å…¥å¼ é‡ <code>I</code>ï¼Œå¯¹å…¶ä¸­å±äºåŒºé—´ <code>R</code> çš„ ID æŸ¥è¯¢ <code>Tr</code> è·å–åµŒå…¥å‘é‡ï¼Œå¯¹è¶…å‡ºèŒƒå›´çš„ ID ç”¨å…¨é›¶å‘é‡æ›¿ä»£ï¼›</li>
<li>è®¡ç®—å¾—åˆ°å±€éƒ¨åµŒå…¥ <code>Er</code>ï¼Œå½¢çŠ¶ä¸æ ‡å‡†åµŒå…¥ <code>E</code> ä¸€è‡´ï¼Œä½†ä»…åŒ…å«åŒºé—´ <code>R</code> å†… ID æœ‰æ•ˆçš„åµŒå…¥å‘é‡ï¼Œå…¶ä½™ä½ç½®ä¸ºå…¨é›¶ã€‚ï¼ˆé€šè¿‡é€šä¿¡ç´¯åŠ æ‰€æœ‰ <strong>GPU</strong> çš„ <code>Er</code> å³å¯é‡æ„å®Œæ•´è¯è¡¨çš„åµŒå…¥ç»“æœï¼Œæœ¬å®éªŒçœå»é€šä¿¡ç´¯åŠ æ­¥éª¤ï¼‰</li>
</ol>
<p>ä¸ <strong>Task2</strong> ç±»ä¼¼ï¼Œä½ è¿˜åº”è¯¥ä¸º <code>ParallelVocabEmbedding</code> æ¨¡å—ç±»å®ç° <code>reset_parameters</code> æ–¹æ³•ï¼Œç”¨äºåµŒå…¥è¡¨ <code>Tr</code> çš„åˆå§‹åŒ–ã€‚ä¸åŒçš„æ˜¯ï¼Œæ­¤æ—¶å‚æ•°ä¸­çš„éšæœºæ•°ç§å­æ˜¯åŸºç¡€éšæœºæ•°ç§å­ï¼Œè®°ä¸º <code>init_base_seed</code>ï¼Œè€ŒçœŸæ­£çš„éšæœºæ•°ç§å­åº”ä¸º <code>init_base_seed + r</code>ï¼Œä»¥é¿å…å¯¹æ‰€æœ‰çš„å‚æ•°çŸ©é˜µè¿›è¡Œç›¸åŒçš„åˆå§‹åŒ–ã€‚</p>
<h2 id="TODO-2"><a href="#TODO-2" class="headerlink" title="TODO"></a>TODO</h2><p>å®Œæˆ <code>src/modeling/vocab_emb.py</code> ä¸­çš„ <code>ParallelVocabEmbedding</code> æ¨¡å—ï¼Œå®ç°ä¸Šè¿°åµŒå…¥è¯è¡¨ã€‚é¦–å…ˆï¼Œä½ éœ€è¦æ ¹æ® <code>init_mean</code>, <code>init_std</code> å’Œ <code>init_base_seed</code>ï¼Œä½¿ç”¨ <strong>normal distribution</strong> å¯¹åµŒå…¥è¡¨ <code>Tr</code> åˆå§‹åŒ–ï¼Œç„¶åå°† <code>I</code> ä½œä¸ºè¾“å…¥ï¼Œå®ç°è¯è¡¨åµŒå…¥ï¼Œå¹¶è¿”å›ä¸å®Œæ•´çš„åµŒå…¥å¼ é‡ <code>Er</code>ã€‚</p>
<div class="note warning">
            <ol><li>è¾“å…¥ <code>I</code> å­˜å‚¨æ¯ä¸ª token çš„ IDï¼Œå…¶ <code>dtype</code> ä¸º <code>torch.long</code>ã€‚</li><li>ä½ çš„å®ç°ä¸åº”è¯¥æ›´æ”¹ <code>I</code>ï¼ŒåŒ…æ‹¬ <code>I</code> çš„æ•°å€¼ä¸å±æ€§ï¼ˆåŒ…æ‹¬ <code>I</code> çš„ <code>shape</code>ï¼Œ <code>dtype</code> å’Œ <code>device</code> ç­‰ï¼‰ï¼Œå› ä¸º <code>I</code> å¯èƒ½è¿˜æœ‰å…¶ä»–ç”¨é€”ã€‚</li><li>å‚æ•°ä¸­çš„ <code>dtype</code> å’Œ <code>device</code> ä»…é’ˆå¯¹å¯å­¦ä¹ åµŒå…¥è¡¨ <code>Tr</code> ï¼Œ<code>Tr</code> çš„ <code>dtype</code> å’Œ <code>device</code> å¯èƒ½ä¸ <code>I</code> çš„ä¸åŒï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‚æ•°å’Œ <code>torch.nn.Parameter</code> å®Œæˆå¯¹ <code>Tr</code> çš„ç”³è¯·ä¸åˆå§‹åŒ–ã€‚</li><li>è¿”å›çš„åµŒå…¥å¼ é‡ <code>Er</code> çš„ <code>device</code> åº”ä¸ <code>I</code> ç›¸åŒï¼Œ<code>dtype</code> ä¸ <code>Tr</code> ç›¸åŒã€‚</li><li>åœ¨æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œ<code>v</code> å‡èƒ½è¢« <code>w</code> æ•´é™¤ï¼Œä½†ä»ç„¶å»ºè®®åœ¨ <code>__init__</code> æ–¹æ³•ä¸­ä½¿ç”¨ <code>assert</code> è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶é™„ä¸Šé”™è¯¯æç¤ºï¼Œè¿™æ˜¯ç¼–ç¨‹çš„è‰¯å¥½ä¹ æƒ¯ã€‚</li></ol>
          </div>
<h1 id="Optional-Task4ï¼šæ—‹è½¬ä½ç½®ç¼–ç "><a href="#Optional-Task4ï¼šæ—‹è½¬ä½ç½®ç¼–ç " class="headerlink" title="[Optional] Task4ï¼šæ—‹è½¬ä½ç½®ç¼–ç "></a>[Optional] Task4ï¼šæ—‹è½¬ä½ç½®ç¼–ç </h1><p>Transformer æ¨¡å‹å°†è¾“å…¥çš„è¯å…ƒï¼ˆtokenï¼‰è§†ä¸ºä¸€ä¸ªâ€œè¯è¢‹â€å¹¶å¹¶è¡Œå¤„ç†ï¼Œå› è€Œæœ¬èº«ä¸å…·å¤‡å¯¹åºåˆ—é¡ºåºçš„æ„ŸçŸ¥èƒ½åŠ›ã€‚ä¸ºä¿ç•™è¾“å…¥ä¸­çš„åºåˆ—ä¿¡æ¯ï¼Œæœ€åˆç‰ˆæœ¬çš„ Transformer å¼•å…¥äº†ä¸€ç§æ–°é¢–çš„æ­£å¼¦ä½ç½®ç¼–ç ï¼ˆSinusoidal Positional Encodingï¼Œç®€ç§° SinPEï¼‰ï¼Œå…¶å®šä¹‰å¦‚ä¸‹é¢å…¬å¼æ‰€ç¤ºï¼š</p>
<script type="math/tex; mode=display">
\text{SinPE}(n) :=
\begin{bmatrix}
\sin{\left(n\theta^0\right)} \cr
\cos{\left(n\theta^0\right)} \cr
\sin{\left(n\theta^1\right)} \cr
\cos{\left(n\theta^1\right)} \cr
\vdots \cr
\sin\left(n\theta^{\frac{d}{2}-1}\right) \cr
\cos\left(n\theta^{\frac{d}{2}-1}\right)
\end{bmatrix}
\quad \text{where }
\theta := \beta^{-1},\
\beta := \text{base}^{\frac{2}{d}},\
n \in \{0, 1, \ldots, L - 1\}
\tag{5}</script><p>å…¶ä¸­ï¼Œ<code>L</code> è¡¨ç¤ºåºåˆ—é•¿åº¦ï¼Œ<code>d</code> è¡¨ç¤ºéšè—å±‚ç»´åº¦ï¼Œ<code>base</code> æ˜¯ä¸€ä¸ªäººä¸ºè®¾å®šçš„å¤§æ•´æ•°ï¼Œé€šå¸¸å–å€¼ä¸º10000ï¼ˆè¯·å‚è€ƒåŸå§‹è®ºæ–‡ï¼‰ï¼Œ$\beta$ æ˜¯ä¸‰è§’å‡½æ•°åŸºçš„æ³¢é•¿æˆ–å‘¨æœŸçš„å¹‚æ¬¡åŸºæ•°ï¼Œéšç€ç»´åº¦ <code>i</code> çš„å¢å¤§è€ŒæŒ‰å‡ ä½•çº§æ•°å¢é•¿ï¼Œå…¶å½¢å¼ä¸º $\beta ^ i$ï¼Œå…¶ä¸­ $i=0,1,\ldots,\frac{d}{2}-1$ã€‚</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ—‹è½¬ä½ç½®ç¼–ç ï¼ˆRotary Position Embeddingï¼Œç®€ç§° RoPEï¼‰åœ¨å¤„ç†é•¿åºåˆ—æ—¶æä¾›äº†æ›´ç¨³å®šçš„æ–¹æ¡ˆã€‚å®ƒåœ¨å…·å¤‡ç»å¯¹ä½ç½®ä¿¡æ¯æ„ŸçŸ¥èƒ½åŠ›çš„åŒæ—¶ï¼Œèƒ½å¤Ÿæ•æ‰ç›¸å¯¹ä½ç½®æ¨¡å¼ï¼Œå› æ­¤è¢«å¹¿æ³›åº”ç”¨äºå½“å‰çš„ä¸»æµå¼€æºå¤§æ¨¡å‹ï¼ˆå¦‚ LLaMAï¼ŒChatCLMï¼‰ä¸­ã€‚éšç€ç ”ç©¶çš„æ¨è¿›ï¼ŒRoPE é€æ¸å–ä»£äº†åŸå§‹çš„ SinPEã€å¯å­¦ä¹ ä½ç½®ç¼–ç ï¼ˆLearnable PEï¼‰ä»¥åŠç›¸å¯¹ä½ç½®ç¼–ç ï¼ˆRelative PEï¼‰ï¼Œæˆä¸ºå½“å‰ Transformer ç»“æ„ä¸­ä½ç½®ç¼–ç çš„ä¸»æµé€‰æ‹©ã€‚</p>
<p>æ›´å…·ä½“çš„è¯´ï¼ŒRoPE åœ¨å¤æ•°åŸŸä¸­å¯¹éšè—çŠ¶æ€è¿›è¡Œæ—‹è½¬æ“ä½œï¼Œè€Œä¸åƒ SinPE é‚£æ ·å°†ä½ç½®ç¼–ç åŠ åˆ°éšè—çŠ¶æ€ä¸­ã€‚è¯¥æ–¹æ³•ä¸ SinPE å…±äº«ç›¸åŒçš„åŸºå‡½æ•°ï¼Œå¦‚ä¸‹å¼æ‰€ç¤ºï¼š</p>
<script type="math/tex; mode=display">
\text{RoPE}(n) := 
\begin{bmatrix}
R_n^{(0)} \cr
\phantom{R_n^{(0)}}& R_n^{(1)} \cr
\phantom{R_n^{(0)}}& \phantom{R_n^{(0)}}& \ddots \cr
\phantom{R_n^{(0)}}&\phantom{R_n^{(0)}}&\phantom{R_n^{(0)}}& R_n^{\left(\frac{d}{2} - 1\right)}
\end{bmatrix},
\quad \text{where } 
R_n^{(i)} := 
\begin{bmatrix}
\cos(n\theta^i) & -\sin(n\theta^i) \cr
\sin(n\theta^i) & \cos(n\theta^i)
\end{bmatrix}
\tag{6}</script><p>å°½ç®¡ RoPEï¼ˆæ—‹è½¬ä½ç½®ç¼–ç ï¼‰å…·å¤‡ç›¸å¯¹è·ç¦»è¡°å‡å’Œè®­ç»ƒç¨³å®šæ€§ç­‰ä¼˜åŠ¿ï¼Œä½†åœ¨åºåˆ—é•¿åº¦çš„å¤–æ¨èƒ½åŠ›æ–¹é¢ä»ç„¶å­˜åœ¨ä¸è¶³ï¼Œå°¤å…¶æ˜¯åœ¨â€œçŸ­åºåˆ—è®­ç»ƒã€é•¿åºåˆ—æ¨ç†â€ï¼ˆTrain Short and Test Longï¼‰åœºæ™¯ä¸‹è¡¨ç°ä¸ä½³ï¼ˆè¯¦è§å‚è€ƒæ–‡çŒ®ä¸­çš„ Length Extrapolation ç›¸å…³è®ºæ–‡ï¼‰ã€‚å› æ­¤ï¼Œå·²æœ‰å¤šé¡¹ç ”ç©¶è‡´åŠ›äºæ‰©å±• RoPE çš„æ³›åŒ–èƒ½åŠ›ï¼Œä½¿å…¶åœ¨æ¨ç†æ—¶èƒ½æœ‰æ•ˆå¤„ç†è¿œè¶…è®­ç»ƒé•¿åº¦çš„åºåˆ—ã€‚</p>
<p>åœ¨è¿™äº›æ–¹æ³•ä¸­ï¼Œ<strong>NTK-aware RoPE</strong> é€šè¿‡ç»“åˆé«˜é¢‘å¤–æ¨å’Œä½é¢‘å†…æ’æ¥æå‡å¤–æ¨æ€§èƒ½ã€‚å®ƒé€šè¿‡ç¼©æ”¾ç³»æ•° $c_ğœ…$ å¯¹å‚æ•° $\beta$ è¿›è¡Œè°ƒæ•´ï¼Œä»è€Œå®ç°åœ¨æœ€ä½é¢‘ç‡é¡¹ä¸Šä»¥æ¯”ä¾‹ $ğœ…$ è¿›è¡Œç­‰æ•ˆæ’å€¼ï¼ŒåŒæ—¶ä¿æŒé«˜é¢‘é¡¹çš„å°ºåº¦ä¸å˜ï¼Œå¦‚ä¸‹å¼æ‰€ç¤ºã€‚è¿™ç§éçº¿æ€§ç¼©æ”¾æ–¹å¼å¯ä»¥ç›´æ¥åº”ç”¨äºä½¿ç”¨ RoPE é¢„è®­ç»ƒçš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ Llamaï¼‰ï¼Œæ— éœ€å¾®è°ƒå³å¯æ‰©å±•å…¶ä¸Šä¸‹æ–‡é•¿åº¦çš„è¾¹ç•Œï¼Œè¿™ä¸€æ–¹æ³•å·²è¢« <em>CodeLlama</em> æ‰€é‡‡çº³ï¼ˆè¯¦è§å‚è€ƒæ–‡çŒ®ä¸­çš„ Llama RoPE æºä»£ç ï¼‰ã€‚</p>
<script type="math/tex; mode=display">
\tilde{\beta} := c_\kappa \cdot \beta, \quad 
s.t. \quad \frac{n}{\tilde{\beta}^{d/2 - 1}} = \frac{n/\kappa}{\beta^{d/2 - 1}} 
\Rightarrow c_\kappa = \kappa^{2/(d - 2)} \tag{7}</script><p>åœ¨ <strong>Task4</strong> ä¸­ï¼Œä½ éœ€è¦åƒ <code>Llama</code> ä¸€æ ·å®ç° <code>NTKAwareRoPE</code> æ¨¡å—ï¼Œä½†æ˜¯ï¼Œæœ‰ä¸€äº›å·®å¼‚å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ ‡å‡†çš„ RoPE æ¨¡å—åœ¨å‰å‘ä¼ æ’­æ—¶ä»…è¿”å›ä½™å¼¦/æ­£å¼¦åŸºå¼ é‡ï¼Œå½¢çŠ¶ä¸º <code>[seqlen, head_dim]</code>ï¼Œè¯¥å‚æ•°å¯¹è®°ä½œ <code>(C, S)</code>ï¼Œåˆ†åˆ«å­˜å‚¨ $\sin{n\theta^i}$ å’Œ  $\cos{n\theta^i}$ï¼ˆè¯·å‚è€ƒ $(5)(6)$ å¼ä¸­å¯¹ $n,\theta$ çš„å®šä¹‰ï¼‰ã€‚å®é™…çš„æ—‹è½¬ç¼–ç æ“ä½œæ˜¯åœ¨å¦ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•° <code>apply_rotary_pos_emb</code> å®Œæˆã€‚</li>
<li><p>æˆ‘ä»¬éµå¾ªè¿™ç§è®¾è®¡æ¨¡å¼ï¼šä½ éœ€è¦åœ¨ <code>src/functional.py</code> ä¸­å®ç° <code>apply_rotary_pos_emb</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ <code>src/modeling/pos_emb.py</code> ä¸­å¯¼å…¥ï¼Œå¹¶åœ¨ <code>NTKAwareRoPE</code> çš„ <code>forward</code> æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚ä¸æ ‡å‡†åšæ³•ä¸åŒçš„æ˜¯ï¼Œ<code>NTKAwareRoPE</code> çš„ <code>forward</code> æ–¹æ³•ä¸ä»…è¿”å› <code>(C, S)</code> çš„åŸºå¼ é‡ï¼Œè¿˜åº”å¯¹è¾“å…¥å¼ é‡ <code>X</code> åº”ç”¨æ—‹è½¬ç¼–ç å¹¶è¿”å›åµŒå…¥åçš„è¾“å‡ºå¼ é‡ <code>E</code>ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>è¾“å…¥å¼ é‡ <code>X</code> çš„å½¢çŠ¶ä¸º <code>[batch_size, seqlen, num_heads, head_dim]</code>ï¼Œè®°ä½œ <code>[b, s, nh, hd]</code>ï¼›</li>
<li>è¾“å‡ºå¼ é‡ <code>E</code> çš„å½¢çŠ¶ä¸ <code>X</code> çš„å½¢çŠ¶ç›¸åŒï¼Œè¡¨ç¤ºåº”ç”¨æ—‹è½¬ç¼–ç åçš„ç»“æœã€‚</li>
</ul>
</li>
<li><p>ç”±äº <strong>RoPE</strong> çŸ©é˜µçš„ç¨€ç–æ€§ï¼Œç›´æ¥ç”¨çŸ©é˜µä¹˜æ³•æ¥å®ç°ä¼šå¾ˆæµªè´¹ç®—åŠ›ï¼Œæ¨èä½¿ç”¨ $(8)$ ä¸­çš„æ–¹æ³•æ¥å®ç°æ ‡å‡† <strong>RoPE</strong>ã€‚å…¶ä¸­ï¼Œ$\bigotimes$ æ˜¯é€ä½ç›¸ä¹˜ï¼Œå¹¶ä¸”å¯ä»¥æ³¨æ„åˆ° $(8)$ ä¸­ï¼Œ$X$ æŒ‰ $(x_0,x_1),(x_2,x_3),\cdots$ çš„é¡ºåºè¿›è¡Œåˆ†ç»„ã€‚è€Œ <code>Llama</code> å’Œ <code>ChatGLM</code> çš„ <strong>RoPE</strong> æ¨¡å—å¯¹ $X$ çš„é¡ºåºè¿›è¡Œäº†é‡ç»„ï¼Œä¹Ÿå³æŒ‰ $(x_0,x_{\frac{d}{2}}),(x_1,x_{\frac{d}{2}+1}),\cdots$ çš„é¡ºåºè¿›è¡Œåˆ†ç»„ï¼Œè¯·ä½¿ç”¨ $(9)$ ä¸­çš„æ–¹æ³•å®ç° <strong>Task4</strong> ä¸­çš„ <strong>RoPE</strong>ã€‚</p>
<div class="note info">
            <p>ä½™å¼¦\æ­£å¼¦å‚æ•°å¯¹ <code>(C, S)</code> ä¹Ÿè¦åšç›¸åº”è°ƒæ•´ã€‚</p>
          </div>
</li>
</ul>
<script type="math/tex; mode=display">
\begin{pmatrix}
x_0 \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_1 \vphantom{\cos{\left(n\theta^0\right)}} \cr
x_2 \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_3 \vphantom{\cos{\left(n\theta^0\right)}}\cr
\vdots \cr
x_{d-2} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}\cr
x_{d-1} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}
\end{pmatrix}
\quad
\bigotimes
\quad
\begin{pmatrix}
\cos{\left(n\theta^0\right)} \cr
\cos{\left(n\theta^0\right)} \cr
\cos{\left(n\theta^1\right)} \cr
\cos{\left(n\theta^1\right)} \cr
\vdots \cr
\cos\left(n\theta^{\frac{d}{2}-1}\right) \cr
\cos\left(n\theta^{\frac{d}{2}-1}\right)
\end{pmatrix}
\quad
+
\quad
\begin{pmatrix}
-x_1 \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_0 \vphantom{\cos{\left(n\theta^0\right)}} \cr
-x_3 \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_2 \vphantom{\cos{\left(n\theta^0\right)}}\cr
\vdots \cr
-x_{d-1} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}\cr
x_{d-2} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}
\end{pmatrix}
\quad
\bigotimes
\quad
\begin{pmatrix}
\sin{\left(n\theta^0\right)} \cr
\sin{\left(n\theta^0\right)} \cr
\sin{\left(n\theta^1\right)} \cr
\sin{\left(n\theta^1\right)} \cr
\vdots \cr
\sin\left(n\theta^{\frac{d}{2}-1}\right) \cr
\sin\left(n\theta^{\frac{d}{2}-1}\right)
\end{pmatrix}
\tag{8}</script><script type="math/tex; mode=display">
\begin{pmatrix}
x_0 \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_1 \vphantom{\cos{\left(n\theta^0\right)}} \cr
x_2 \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_3 \vphantom{\cos{\left(n\theta^0\right)}}\cr
\vdots \cr
x_{\frac{d}{2}-1} \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_{\frac{d}{2}} \vphantom{\cos{\left(n\theta^0\right)}} \cr
x_{\frac{d}{2}+1} \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_{\frac{d}{2}+2} \vphantom{\cos{\left(n\theta^0\right)}}\cr
\vdots \cr
x_{d-2} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}\cr
x_{d-1} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}
\end{pmatrix}
\quad
\bigotimes
\quad
\begin{pmatrix}
\cos{\left(n\theta^0\right)} \cr
\cos{\left(n\theta^1\right)} \cr
\cos{\left(n\theta^2\right)} \cr
\cos{\left(n\theta^3\right)} \cr
\vdots \cr
\cos\left(n\theta^{\frac{d}{2}-1}\right) \cr
\cos{\left(n\theta^0\right)} \cr
\cos{\left(n\theta^1\right)} \cr
\cos{\left(n\theta^2\right)} \cr
\vdots \cr
\cos\left(n\theta^{\frac{d}{2}-2}\right) \cr
\cos\left(n\theta^{\frac{d}{2}-1}\right)
\end{pmatrix}
\quad
+
\quad
\begin{pmatrix}
-x_{\frac{d}{2}} \vphantom{\cos{\left(n\theta^0\right)}}\cr
-x_{\frac{d}{2}+1} \vphantom{\cos{\left(n\theta^0\right)}} \cr
-x_{\frac{d}{2}+2} \vphantom{\cos{\left(n\theta^0\right)}}\cr
-x_{\frac{d}{2}+3} \vphantom{\cos{\left(n\theta^0\right)}}\cr
\vdots \cr
-x_{d-1} \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_0 \vphantom{\cos{\left(n\theta^0\right)}} \cr
x_1 \vphantom{\cos{\left(n\theta^0\right)}}\cr
x_2 \vphantom{\cos{\left(n\theta^0\right)}}\cr
\vdots \cr
x_{\frac{d}{2}-2} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}\cr
x_{\frac{d}{2}-1} \vphantom{\cos\left(n\theta^{\frac{d}{2}-1}\right)}
\end{pmatrix}
\quad
\bigotimes
\quad
\begin{pmatrix}
\sin{\left(n\theta^0\right)} \cr
\sin{\left(n\theta^1\right)} \cr
\sin{\left(n\theta^2\right)} \cr
\sin{\left(n\theta^3\right)} \cr
\vdots \cr
\sin\left(n\theta^{\frac{d}{2}-1}\right) \cr
\sin{\left(n\theta^0\right)} \cr
\sin{\left(n\theta^1\right)} \cr
\sin{\left(n\theta^2\right)} \cr
\vdots \cr
\sin\left(n\theta^{\frac{d}{2}-2}\right) \cr
\sin\left(n\theta^{\frac{d}{2}-1}\right)
\end{pmatrix}
\tag{9}</script><ul>
<li>å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåˆå§‹åŒ– <code>NTKAwareRoPE</code> æ—¶ä¼šæä¾›ä¸€ä¸ªè®­ç»ƒé˜¶æ®µä½¿ç”¨çš„æœ€å¤§åºåˆ—é•¿åº¦ï¼ˆè®°ä½œ <code>ms</code>ï¼‰å’Œä¸€ä¸ªç¼©æ”¾æ¯”ä¾‹ï¼ˆè®°ä½œ <code>k</code>ï¼Œä¹Ÿå³ $\kappa$ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é¢„å…ˆè®¡ç®—å¥½ <code>(C, S)</code>ï¼Œå…¶å½¢çŠ¶ä¸º <code>[es, hd]</code>ï¼Œå…¶ä¸­ <code>es = ms x k</code> è¡¨ç¤ºæœ€å¤§æ”¯æŒçš„æ‹“å±•åºåˆ—é•¿åº¦ã€‚å› æ­¤ï¼Œå½“æœ‰ä¸€ä¸ªè¾“å…¥å¼ é‡ <code>X_</code> çš„å®é™…åºåˆ—é•¿åº¦ <code>s_</code> è¶…è¿‡äº† <code>es</code>ï¼Œå³ <code>s_ &gt; es</code>ï¼Œæˆ‘ä»¬å¿…é¡»åŠ¨æ€é‡æ–°è®¡ç®—ä¸€å¯¹æ–°çš„ <code>(C_, S_)</code>ï¼Œä»¥ç¡®ä¿æ—‹è½¬ç¼–ç æ“ä½œå¯ä»¥é€‚ç”¨äºè¿™ç±»è¶…é•¿è¾“å…¥ã€‚</li>
<li>ä½†è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š<ol>
<li>å½“éœ€è¦é‡æ–°è®¡ç®—æ–°çš„ä½™å¼¦/æ­£å¼¦åŸº <code>(C&#39;, S&#39;)</code> æ—¶ï¼Œæˆ‘ä»¬åº”å¦‚ä½•ä¸ºè¾“å…¥å¼ é‡ <code>X&#39;</code> ç¡®å®šæ–°çš„ç¼©æ”¾æ¯”ä¾‹ <code>k&#39;</code> ï¼Ÿ</li>
<li>å½“é‡åˆ°è¿™ç±»è¶…é•¿åºåˆ—æ—¶ï¼Œæˆ‘ä»¬æ˜¯å¦åº”è¯¥æ¯æ¬¡ä»…è®¡ç®—å¹¶ä½¿ç”¨è¯¥è¾“å…¥æ‰€éœ€çš„ <code>(C&#39;, S&#39;)</code>ï¼ŒåŒæ—¶ä¿ç•™åŸå§‹çš„ç¼©æ”¾æ¯”ä¾‹ <code>k</code> åŠå…¶å¯¹åº”çš„ <code>(C, S)</code> ç”¨äºå¸¸è§„è¾“å…¥ï¼Ÿæˆ–è€…ï¼Œæˆ‘ä»¬åº”è¯¥æ¯æ¬¡éƒ½æ›´æ–°å½“å‰çš„ <code>k</code> åŠå…¶å¯¹åº”çš„ <code>(C, S)</code> ä¸ºæ–°çš„ <code>k&#39;</code> å’Œ <code>(C&#39;, S&#39;)</code> ï¼Ÿ</li>
</ol>
</li>
<li>ä¸Šè¿°é—®é¢˜å°šæ— æ ‡å‡†ç­”æ¡ˆã€‚åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨å¦‚ä¸‹ç­–ç•¥ï¼š<ol>
<li>å½“å‡ºç°æ–°çš„è¾“å…¥é•¿åº¦ <code>s&#39; &gt; es</code> æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©æ»¡è¶³ <code>es&#39; = ms x k&#39; &gt;= s&#39;</code> çš„æœ€å° <code>k&#39;</code>ï¼Œå…¶ä¸­ <code>k&#39;</code> æ˜¯ä¸€ä¸ªå¶æ•°ï¼›</li>
<li>æˆ‘ä»¬åœ¨åˆå§‹åŒ– <code>NTKAwareRoPE</code> æ¨¡å—æ—¶æ–°å¢äº†ä¸€ä¸ªå‚æ•° <code>dynamic</code>ã€‚å½“ <code>dynamic = True</code> æ—¶ï¼Œæ¯æ¬¡é‡åˆ°è¶…å‡ºé•¿åº¦çš„è¾“å…¥æ—¶ï¼Œéƒ½ä¼šæ›´æ–°å½“å‰çš„ $k \leftarrow kâ€™$ ä»¥åŠ $(C,S) \leftarrow (Câ€™, Sâ€™)$ï¼›åä¹‹ï¼Œè‹¥ <code>dynamic = False</code> æ—¶ï¼Œåˆ™ä»…ä¸ºå½“å‰è¶…é•¿è¾“å…¥ä¸´æ—¶è®¡ç®—å¹¶ä½¿ç”¨ $(Câ€™,Sâ€™)$ï¼Œè€Œå…¨å±€çš„ $k$ å’Œ $(C,S)$ ä¿æŒä¸å˜ã€‚ </li>
</ol>
</li>
</ul>
<h2 id="TODO-3"><a href="#TODO-3" class="headerlink" title="TODO"></a>TODO</h2><p>å®Œæˆ <code>NTKAwareRoPe</code> æ¨¡å—ã€‚è¯¥æ¨¡å—é¦–å…ˆæ ¹æ®å‚æ•° <code>hd</code> , <code>ms</code>, <code>base</code>, <code>k</code> åˆå§‹åŒ–åŸå§‹çš„ä½ç½®ç¼–ç å‚æ•°å¯¹ <code>(C, S)</code>ã€‚æ¥ç€ï¼Œæ¨¡å—æ¥æ”¶å½¢çŠ¶ä¸º<code>[b, s, nh, hd]</code>çš„è¾“å…¥å¼ é‡<code>X</code>ï¼Œå¹¶æŒ‰ä»¥ä¸‹é€»è¾‘å¤„ç†ï¼šå½“åºåˆ—é•¿åº¦ <code>s</code> å°äºç­‰äºé¢„è®¾æœ€å¤§é•¿åº¦ <code>es</code> æ—¶ï¼Œç›´æ¥è°ƒå–ç¼“å­˜çš„ <code>(C, S)</code> å‚æ•°ï¼›è‹¥<code>s &gt; es</code>ï¼Œåˆ™é‡æ–°è®¡ç®—å‡ºæ–°çš„å‚æ•° <code>k_</code> ï¼Œå¹¶é‡æ–°è®¡ç®—æ–°çš„å‚æ•°å¯¹ <code>(C_, S_)</code>ã€‚ç‰¹åˆ«åœ°ï¼Œå½“å‚æ•° <code>dynamic</code> è®¾ä¸º True æ—¶ï¼Œæ¨¡å—ä¼šåœ¨é‡æ–°è®¡ç®—ååŒæ­¥æ›´æ–°å†…éƒ¨å­˜å‚¨çš„ <code>k</code> å€¼åŠ <code>(C, S)</code> å‚æ•°ã€‚æœ€åï¼Œæ¨¡å—å°†é€šè¿‡è°ƒç”¨éœ€è‡ªè¡Œå®ç°çš„ <code>apply_rotary_pos_emb</code> å‡½æ•°ï¼Œå°†å¯¹åº”ä½ç½®çš„ <code>(C, S)</code> å‚æ•°åº”ç”¨äºè¾“å…¥å¼ é‡ <code>X</code> ï¼Œå®Œæˆæ—‹è½¬ä½ç½®ç¼–ç æ“ä½œå¹¶è¿”å›ç¼–ç ç»“æœ <code>E</code> ã€‚</p>
<div class="note warning">
            <ol><li>å‚æ•°ä¸­çš„ <code>dtype</code> å’Œ <code>device</code> ä»…é’ˆå¯¹ä½ç½®ç¼–ç å‚æ•°å¯¹ <code>(C, S)</code>ã€‚é€šå¸¸æˆ‘ä»¬éœ€è¦æ›´é«˜çš„ç²¾åº¦æ¥å¤„ç†ä½ç½®åµŒå…¥ï¼Œå› æ­¤åœ¨æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†æ•°æ®ç±»å‹å›ºå®šä¸º <code>float32</code>ï¼Œå¹¶ä¸”å»ºè®®æ‚¨åœ¨è®¡ç®—çš„æ¯ä¸€æ­¥éƒ½ä½¿ç”¨ <code>float32</code> ä»¥ç¡®ä¿ç²¾åº¦ä¸€è‡´æ€§ã€‚</li><li>è¿”å›çš„å¼ é‡ <code>E</code> åº”ä¸è¾“å…¥å¼ é‡ <code>X</code> ä¿æŒç›¸åŒçš„ <code>dtype</code> å’Œ <code>device</code>ã€‚</li><li>åœ¨å®é™…å®ç°ä¸­ï¼Œä½ç½®ç¼–ç å‚æ•°å¯¹ <code>(C, S)</code> åº”è¢«è§†ä¸ºæ¨¡å—çŠ¶æ€çš„ä¸€éƒ¨åˆ†ï¼Œä¸ä»…è¦èƒ½å¤Ÿéšç€æ¨¡å—ä¸€èµ·è¿ç§»è®¾å¤‡ï¼ˆä¾‹å¦‚é€šè¿‡ <code>module.to(device)</code> æ–¹æ³•ï¼‰ï¼Œè¿˜åº”åœ¨ä¿å­˜æ¨¡å‹çŠ¶æ€å­—å…¸æ—¶è¢«å¿½ç•¥ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æ ¹æ®éœ€è¦è½»æ¾é‡æ„ã€‚å› æ­¤ï¼Œæ‚¨ä¸åº”å°† <code>(C, S)</code> ä½œä¸ºæ™®é€š Python å±æ€§ç›´æ¥èµ‹å€¼ç»™ <code>self</code>ï¼Œè€Œæ˜¯åº”å°†å…¶æ³¨å†Œä¸º PyTorch çš„éæŒä¹…ç¼“å†²åŒºï¼ˆNon-persistent Bufferï¼‰ã€‚å…·ä½“æ“ä½œè¯·å‚è€ƒ PyTorch æ–‡æ¡£ä¸­å…³äºæ¨¡å—æ³¨å†Œçš„ç›¸å…³å†…å®¹ã€‚</li><li>æ‚¨å¯ä»¥å‚è€ƒ Llama å’Œ ChatGLM ç­‰æ¨¡å‹å®ç°æ—‹è½¬ä½ç½®ç¼–ç ï¼ˆRoPEï¼‰çš„æ–¹å¼ï¼Œä½†è¯·ç‰¹åˆ«æ³¨æ„ä¸Šè¿°è¦æ±‚ï¼Œè¿™äº›è¦æ±‚ä¸ Llama å’Œ ChatGLM çš„å®ç°ç»†èŠ‚å­˜åœ¨å·®å¼‚ã€‚</li></ol>
          </div>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><em>æç¤ºï¼šä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½å¯¹ä½ çš„ä»»åŠ¡æœ‰å¸®åŠ©çš„å‚è€ƒèµ„æ–™ï¼Œæˆ–è€…å¯ä»¥åŠ æ·±/æ‹“å±•ä½ å¯¹æ·±åº¦å­¦ä¹ ä¸­å½’ä¸€åŒ–å±‚ï¼Œè¯è¡¨åµŒå…¥å±‚å’Œä½ç½®ç¼–ç çš„ç†è§£ï¼š</em></p>
<p><strong>!! è¯·è®°ä½ï¼šæŸ¥é˜…è®ºæ–‡ã€æºç ä»¥åŠå®˜æ–¹æ–‡æ¡£ï¼Œå¹¶ä»ä¸­è¿›è¡Œæ€è€ƒå’Œå­¦ä¹ ï¼Œæ˜¯ä¸€é¡¹åŸºæœ¬ä¸”è‡³å…³é‡è¦çš„èƒ½åŠ›ã€‚è¯·å°½é‡ä¸è¦è¿‡åº¦ä¾èµ–ä¸€äº›å¸¦æœ‰åè§æˆ–å†…å®¹æµ…æ˜¾çš„åšå®¢ï¼Œä¾‹å¦‚ CSDN !!</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1910.07467">RMSNorm Paper</a></li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.RMSNorm.html#rmsnorm">Pytorch RMSNorm Module</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/huggingface/transformers/blob/v4.46.3/src/transformers/models/llama/modeling_llama.py#L60">Llama RMSNorm Module</a></li>
<li><a target="_blank" rel="noopener" href="https://huggingface.co/THUDM/chatglm3-6b/blob/main/modeling_chatglm.py#L181">ChatGLM RMSNorm Module</a></li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.LayerNorm.html#torch.nn.LayerNorm">Pytorch LayerNorm Module</a></li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.BatchNorm1d.html#torch.nn.BatchNorm1d">Pytorch BatchNorm Module</a></li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.GroupNorm.html#torch.nn.GroupNorm">Pytorch GroupNorm Module</a></li>
<li><p><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/nn.init.html#torch.nn.init.uniform_">Pytorch Uniform Initialization</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.Embedding.html">Pytorch Embedding Module</a></p>
</li>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.functional.embedding.html">Pytorch Embedding Functional</a></li>
<li><a target="_blank" rel="noopener" href="https://huggingface.co/THUDM/chatglm3-6b/blob/main/modeling_chatglm.py#L706">ChatGLM Vocab Embedding Module</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/Megatron-LM/blob/main/megatron/core/tensor_parallel/layers.py#L156">Megatron Vovab Parallel Embedding Module</a></li>
<li><p><a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/nn.init.html#torch.nn.init.normal_">Pytorch Normal Initialization</a></p>
</li>
<li><p><code>SinPE</code>: <a target="_blank" rel="noopener" href="https://arxiv.org/abs/1706.03762">paper</a> | <a target="_blank" rel="noopener" href="https://spaces.ac.cn/archives/8231">blog</a></p>
</li>
<li><code>RoPE</code>: <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2104.09864">paper</a> | <a target="_blank" rel="noopener" href="https://spaces.ac.cn/archives/8265">blog</a></li>
<li><code>Length Extrapolation</code>: <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2108.12409">Alibi</a> | <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2306.15595">PI</a></li>
<li><code>NTK-aware RoPE</code>: <a target="_blank" rel="noopener" href="https://www.reddit.com/r/LocalLLaMA/comments/14lz7j5/ntkaware_scaled_rope_allows_llama_models_to_have/">blog</a> | <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2309.00071">paper</a> | <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2311.12351">survey</a></li>
<li><code>Llama RoPE</code>:  <a target="_blank" rel="noopener" href="https://github.com/huggingface/transformers/blob/v4.36.2/src/transformers/models/llama/modeling_llama.py#L178">module</a> | <a target="_blank" rel="noopener" href="https://github.com/huggingface/transformers/blob/v4.36.2/src/transformers/models/llama/modeling_llama.py#L211">function</a></li>
<li><code>ChatGLM RoPE</code>: <a target="_blank" rel="noopener" href="https://huggingface.co/THUDM/chatglm3-6b/blob/main/modeling_chatglm.py#L121">module</a> | <a target="_blank" rel="noopener" href="https://huggingface.co/THUDM/chatglm3-6b/blob/main/modeling_chatglm.py#L121">function</a></li>
<li><code>Pytorch Module Register</code>: <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module.register_buffer">buffer</a> | <a target="_blank" rel="noopener" href="https://pytorch.org/docs/stable/generated/torch.nn.Module.html#torch.nn.Module.register_parameter">parameter</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/LLM-Blog/tags/RMSNorm/" rel="tag"># RMSNorm</a>
              <a href="/LLM-Blog/tags/Vocab-Embedding/" rel="tag"># Vocab Embedding</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/LLM-Blog/2025/06/14/A1-matmul/" rel="prev" title="A1 Matmul">
      <i class="fa fa-chevron-left"></i> A1 Matmul
    </a></div>
      <div class="post-nav-item">
    <a href="/LLM-Blog/2025/06/29/A3-modeling-mlp/" rel="next" title="A3 Modeling MLP">
      A3 Modeling MLP <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Task-1-%E5%9D%87%E6%96%B9%E6%A0%B9%E5%B1%82%E5%BD%92%E4%B8%80%E5%8C%96-RMS-Norm"><span class="nav-number">1.</span> <span class="nav-text">Task 1: å‡æ–¹æ ¹å±‚å½’ä¸€åŒ– (RMS Norm)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO"><span class="nav-number">1.1.</span> <span class="nav-text">TODO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Task-2-%E5%B5%8C%E5%85%A5%E8%AF%8D%E8%A1%A8-Vocab-Embedding"><span class="nav-number">2.</span> <span class="nav-text">Task 2: åµŒå…¥è¯è¡¨ (Vocab Embedding)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO-1"><span class="nav-number">2.1.</span> <span class="nav-text">TODO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Task-3-%E5%88%86%E5%B8%83%E5%BC%8F%E5%B9%B6%E8%A1%8C%E5%B5%8C%E5%85%A5%E8%AF%8D%E8%A1%A8-Parallel-Vocab-Embedding"><span class="nav-number">3.</span> <span class="nav-text">Task 3: åˆ†å¸ƒå¼å¹¶è¡ŒåµŒå…¥è¯è¡¨ (Parallel Vocab Embedding)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO-2"><span class="nav-number">3.1.</span> <span class="nav-text">TODO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Optional-Task4%EF%BC%9A%E6%97%8B%E8%BD%AC%E4%BD%8D%E7%BD%AE%E7%BC%96%E7%A0%81"><span class="nav-number">4.</span> <span class="nav-text">[Optional] Task4ï¼šæ—‹è½¬ä½ç½®ç¼–ç </span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO-3"><span class="nav-number">4.1.</span> <span class="nav-text">TODO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">DeepEngine</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/LLM-Blog/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/LLM-Blog/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DeepEngine</span>
</div>

<!--
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div> -->

        








      </div>
    </footer>
  </div>

  
  <script src="/LLM-Blog/lib/anime.min.js"></script>
  <script src="/LLM-Blog/lib/velocity/velocity.min.js"></script>
  <script src="/LLM-Blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/LLM-Blog/js/utils.js"></script>

<script src="/LLM-Blog/js/motion.js"></script>


<script src="/LLM-Blog/js/schemes/pisces.js"></script>


<script src="/LLM-Blog/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
